<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Logger</title>
<link rel="stylesheet" type="text/css" href="css/prettify.css">
<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
<style type="text/css">
body {
	padding-top: 60px;
	padding-bottom: 40px;
}
.hide {
	display: none;
}
#logger {
	padding-right:10px;
	height: 600px;
	overflow-y: scroll;
}
#logger pre:first-child {
	background: #D9EDF7;
}
</style>
</head>
<body>
<div class="container">
	<form class="well form-search">
		<input id="channel" type="text" class="input-medium" placeholder="Channel">
		<button type="button" id="btn-go-channel" class="hide btn">Go</button>
		<button type="button" id="btn-test-channel" class="hide btn">Test</button>
	</form>
	<div id="logWrapper" class="hide">
		<div id="ctrl">
			<button class="btn clear">Clear</button>
		</div>
		<hr>
		<div class="row">
			<div id="logger" class="span12"></div>
		</div>
	</div>
</div>
<script src="http://js.pusher.com/1.11/pusher.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/jquery-1.7.1.js" type="text/javascript"></script>
<script src="js/prettify.js" type="text/javascript"></script>
<script src="js/logger.js" type="text/javascript"></script>
<script type="text/javascript">
(function () {
	// prefix _ = context global
	// prefix $ = jquery object
	var _$ctrl = $('#ctrl'),
		_$logger = $('#logger'),
		_channelQuery = /channel=(\w+)/.exec(location.search),
		_channelName = _channelQuery && _channelQuery[1];
	
	function init() {
		if (_channelName) {
			initPusher();
			initLoggerTool();
			$('#logWrapper').show();
		}
		initChannel();
	}
	
	function initChannel() {
		if (_channelName) {
			$('#channel').val(_channelName);
			
			$('#btn-test-channel')
				.click(function () {
					Logger.setChannel(_channelName);
					Logger.on();
					Logger.log('Test success.');
				})
				.show();
				
		} else {
			$('#btn-go-channel')
				.click(function () {
					location.href = location.href + '?channel=' + $('#channel').val();
				})
				.show();
		}
	}
	
	function initPusher() {
		var pusher = new Pusher('d03a114b02555f531883');
		
		if (_channelName) {
		    var channel = pusher.subscribe(_channelName);
		    channel.bind('log_event', function(data) {
		    	print(data);
		    });
		}
	}
	
	function print(data) {
		var html = '<pre class="prettyprint">' + JSON.stringify(data) + '</pre>';
		var prettied = prettyPrintOne(html); // google pretty print (prettify.js)
		_$logger.prepend(prettied);
	}
	
	function initLoggerTool() {
		_$ctrl
			// Clear logs
			.find('.clear')
				.click(function () {
					_$logger.empty();
				})
				.end();
	}
	
	// main
	init();
})();
</script>
</body>
</html>